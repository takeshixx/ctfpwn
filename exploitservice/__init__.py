#!/usr/bin/env python3
import sys
import logging

from twisted.internet.task import LoopingCall
from twisted.internet import pollreactor
pollreactor.install()
from twisted.internet import reactor
from helperlib.logging import default_config, load_config

from .exploitdb import ExploitDB
from .supervisor import Supervisor

STATS_INTERVAL = 8
SUPERVISOR_INTERVAL = 25

log = logging.getLogger(__name__)


# TODO: Maybe implement alive checks in separate class/LoopingCall
class Target():
    """
    An instance represents a single target system. It should provide
    information if the host is alive (pingable) and which service
    ports are open.
    """
    def __init__(self, host):
        self.host = host
        self.is_alive = False
        self.services_alive = []


def run_exploitservice():
    try:
        load_config('exploitservice.ini', disable_existing_loggers=False)
    except Exception as e:
        default_config(level=logging.DEBUG, disable_existing_loggers=False)
        log.warning('No logging config file exploitservice.ini found. Using default')

    try:
        log.info('Starting exploitservice')
        exploit_db = ExploitDB()

        looper = LoopingCall(exploit_db.exploit_stats)
        looper.start(STATS_INTERVAL, now=True)

        supervisor = Supervisor(db=exploit_db)
        supervisor.start(SUPERVISOR_INTERVAL, now=True)

        reactor.run()
    except KeyboardInterrupt:
        reactor.stop()
        sys.exit(0)
    except Exception as e:
        print(e)
        sys.exit(1)

if __name__ == '__main__':
    run_exploitservice()
